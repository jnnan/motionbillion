<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVH Animation Generator</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        canvas { display: block; }

        /* UI Panel Styles */
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 350px;
            z-index: 1000;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        #ui-panel h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
        }

        #prompt-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        #prompt-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        #generate-btn {
            width: 100%;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #generate-btn:hover:not(:disabled) {
            background-color: #45a049;
        }

        #generate-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loader {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0c5460;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .examples {
            margin-top: 10px;
        }

        .examples h3 {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .example-btn {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .example-btn:hover {
            background-color: #e0e0e0;
        }

        /* Animation Controls */
        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
        }

        .toggle-button {
            width: 100%;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-button:hover {
            background-color: #e0e0e0;
        }

        .toggle-button.playing {
            background-color: #ffeb3b;
            border-color: #fbc02d;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 5px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider-value {
            min-width: 35px;
            text-align: right;
            font-size: 13px;
            color: #666;
        }

        .no-animation {
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Combined UI Panel -->
    <div id="ui-panel">
        <h2>BVH Animation Studio</h2>

        <!-- Generator Section -->
        <div class="section">
            <div class="section-title">Generate Animation</div>

            <div class="input-group">
                <label for="prompt-input">Animation description:</label>
                <input
                    type="text"
                    id="prompt-input"
                    placeholder="e.g., 唱，跳舞，rap，篮球..."
                    maxlength="200"
                />
            </div>

            <button id="generate-btn">Generate Animation</button>

            <div class="examples">
                <h3>Quick examples:</h3>
                <span class="example-btn" onclick="setExample('唱')">唱</span>
                <span class="example-btn" onclick="setExample('跳')">跳</span>
                <span class="example-btn" onclick="setExample('Rap')">Rap</span>
                <span class="example-btn" onclick="setExample('篮球')">篮球</span>
            </div>

            <div id="status-message"></div>
        </div>

        <!-- Animation Controls Section -->
        <div class="section">
            <div class="section-title">Animation Controls</div>

            <div id="animation-controls">
                <div class="no-animation">No animation loaded</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { BVHLoader } from 'three/addons/loaders/BVHLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 3);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xeeeeee);
        document.body.appendChild(renderer.domElement);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
        hemiLight.position.set(0, 20, 0);
        scene.add(hemiLight);

        // Add grid helper
        const gridHelper = new THREE.GridHelper(20, 20, 0x000000, 0x000000);
        gridHelper.material.opacity = 0.2;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);

        // Orbit controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0, 0);
        controls.update();

        // Animation variables
        const clock = new THREE.Clock();
        let mixer;
        let action;
        let currentSkeleton = null;

        // Function to add visual meshes to bones
        function addVisualsToBone(bone) {
            for (let child of bone.children) {
                if (child instanceof THREE.Bone) {
                    const length = child.position.length();
                    if (length > 0) {
                        const direction = child.position.clone().normalize();

                        const radius = 0.03;
                        const cylLength = Math.max(0, length - 1 * radius);
                        const capsuleGeom = new THREE.CapsuleGeometry(radius, cylLength, 8, 16);
                        const capsuleMat = new THREE.MeshPhongMaterial({ color: 0xFF8000 });
                        const capsule = new THREE.Mesh(capsuleGeom, capsuleMat);

                        capsule.position.copy(child.position.clone().multiplyScalar(0.5));
                        capsule.setRotationFromQuaternion(
                            new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction)
                        );

                        bone.add(capsule);
                        addVisualsToBone(child);
                    }
                }
            }
        }

        // Function to create animation controls
        function createAnimationControls() {
            if (!action) {
                document.getElementById('animation-controls').innerHTML =
                    '<div class="no-animation">No animation loaded</div>';
                return;
            }

            const controlsHTML = `
                <div class="control-group">
                    <button id="play-pause-btn" class="toggle-button playing">
                        Pause Animation
                    </button>
                </div>

                <div class="control-group">
                    <label for="speed-slider">Playback Speed</label>
                    <div class="slider-container">
                        <input type="range" id="speed-slider" class="slider"
                               min="0" max="200" value="100" step="1">
                        <span id="speed-value" class="slider-value">1.0x</span>
                    </div>
                </div>

                <div class="control-group">
                    <label for="progress-slider">Animation Progress</label>
                    <div class="slider-container">
                        <input type="range" id="progress-slider" class="slider"
                               min="0" max="100" value="0" step="0.1">
                        <span id="progress-value" class="slider-value">0%</span>
                    </div>
                </div>
            `;

            document.getElementById('animation-controls').innerHTML = controlsHTML;

            // Play/Pause button
            const playPauseBtn = document.getElementById('play-pause-btn');
            playPauseBtn.addEventListener('click', () => {
                if (action.paused) {
                    action.paused = false;
                    playPauseBtn.textContent = 'Pause Animation';
                    playPauseBtn.classList.add('playing');
                } else {
                    action.paused = true;
                    playPauseBtn.textContent = 'Play Animation';
                    playPauseBtn.classList.remove('playing');
                }
            });

            // Speed slider
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            speedSlider.addEventListener('input', (e) => {
                const speed = e.target.value / 100;
                action.timeScale = speed;
                speedValue.textContent = speed.toFixed(1) + 'x';
            });

            // Progress slider
            const progressSlider = document.getElementById('progress-slider');
            const progressValue = document.getElementById('progress-value');
            let isProgressDragging = false;

            progressSlider.addEventListener('mousedown', () => {
                isProgressDragging = true;
                action.paused = true;
            });

            progressSlider.addEventListener('mouseup', () => {
                isProgressDragging = false;
                action.paused = false;
                playPauseBtn.textContent = 'Pause Animation';
                playPauseBtn.classList.add('playing');
            });

            progressSlider.addEventListener('input', (e) => {
                if (isProgressDragging && action) {
                    const progress = e.target.value / 100;
                    action.time = action.getClip().duration * progress;
                    progressValue.textContent = Math.round(progress * 100) + '%';
                    mixer.update(0);
                }
            });

            // Update progress slider automatically
            window.updateProgressSlider = () => {
                if (!isProgressDragging && action && !action.paused) {
                    const progress = (action.time / action.getClip().duration) * 100;
                    progressSlider.value = progress;
                    progressValue.textContent = Math.round(progress) + '%';
                }
            };
        }

        // UI Functions
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = '';
            statusDiv.style.display = 'block';

            if (type === 'loading') {
                statusDiv.innerHTML = '<span class="loader"></span>' + message;
                statusDiv.classList.add('status-loading');
            } else {
                statusDiv.innerHTML = message;
                statusDiv.classList.add(`status-${type}`);
            }

            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function hideStatus() {
            const statusDiv = document.getElementById('status-message');
            statusDiv.style.display = 'none';
        }

        // Function to load BVH
        function loadBVH(url, onSuccess, onError) {
            // Clear previous skeleton if exists
            if (currentSkeleton) {
                scene.remove(currentSkeleton);
                currentSkeleton = null;
            }

            // Clear previous mixer
            if (mixer) {
                mixer.stopAllAction();
                mixer = null;
            }

            const loader = new BVHLoader();
            loader.load(url, function (result) {
                const skeleton = result.skeleton;
                const clip = result.clip;

                console.log('Clip duration:', clip.duration);
                console.log('Number of tracks:', clip.tracks.length);

                skeleton.bones[0].skeleton = skeleton;
                scene.add(skeleton.bones[0]);
                currentSkeleton = skeleton.bones[0];

                addVisualsToBone(skeleton.bones[0]);

                mixer = new THREE.AnimationMixer(skeleton.bones[0]);
                action = mixer.clipAction(clip);
                action.play();
                action.setLoop(THREE.LoopRepeat);

                // Create animation controls
                createAnimationControls();

                // Call success callback
                if (onSuccess) onSuccess();
            },
            undefined,
            function (error) {
                console.error('Error loading BVH:', error);
                if (onError) onError(error);
                createAnimationControls(); // Show "No animation loaded"
            });
        }

        // Initial load
        // loadBVH('/bvh_files/output.bvh');

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) {
                mixer.update(delta);
                // Update progress slider
                if (window.updateProgressSlider) {
                    window.updateProgressSlider();
                }
            }
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Set example prompt
        window.setExample = function(text) {
            document.getElementById('prompt-input').value = text;
        }

        // Generate button handler
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const prompt = document.getElementById('prompt-input').value.trim();

            if (!prompt) {
                showStatus('Please enter an animation description', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            showStatus('Generating animation...', 'loading');

            try {
                const response = await fetch("https://583367f9d739.ngrok-free.app/generate_bvh_file", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ description: prompt })
                });

                if (response.ok) {
                    // Get the BVH content as text
                    const bvhContent = await response.text();

                    // Create a Blob from the BVH content
                    const blob = new Blob([bvhContent], { type: 'text/plain' });
                    const blobUrl = URL.createObjectURL(blob);

                    // Load the BVH with callbacks
                    loadBVH(blobUrl,
                        // Success callback
                        () => {
                            showStatus('Animation loaded successfully!', 'success');
                        },
                        // Error callback
                        (error) => {
                            showStatus('Error loading animation file', 'error');
                        }
                    );
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Failed to generate animation';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // If response is not JSON, use default error message
                    }
                    showStatus(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Network error. Please try again.', 'error');
            } finally {
                generateBtn.disabled = false;
            }
        });

        // Allow Enter key to generate
        document.getElementById('prompt-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('generate-btn').click();
            }
        });
    </script>
</body>
</html>
